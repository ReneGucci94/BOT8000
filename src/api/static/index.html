<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOT8000 V3 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
                BOT8000 AI TRADER</h1>
            <div class="flex gap-4">
                <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Refresh</button>
                <button onclick="startPipeline()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Run AI
                    Pipeline</button>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-gray-400 text-sm">Active Strategies</h3>
                <p id="stat-strategies" class="text-3xl font-bold mt-2">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-gray-400 text-sm">Total Trades</h3>
                <p id="stat-trades" class="text-3xl font-bold mt-2">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-gray-400 text-sm">Win Rate (Last 100)</h3>
                <p id="stat-winrate" class="text-3xl font-bold mt-2 text-green-400">0%</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-gray-400 text-sm">Identified Patterns</h3>
                <p id="stat-patterns" class="text-3xl font-bold mt-2 text-purple-400">0</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Strategies List -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Approved Strategies</h2>
                <div id="strategies-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Dynamic Content -->
                    <div class="text-gray-500 italic">No approved strategies yet.</div>
                </div>
            </div>

            <!-- Recent Activity / Task Status -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Pipeline Status</h2>
                <div id="pipeline-status"
                    class="bg-gray-900 p-4 rounded min-h-[100px] font-mono text-sm text-green-400">
                    System Ready.
                </div>
            </div>
        </div>

        <!-- ML Patterns -->
        <div class="mt-8 bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-4">Detected Failure Patterns (ML)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="pb-2">Description</th>
                            <th class="pb-2">Win Rate (in context)</th>
                            <th class="pb-2">Samples</th>
                        </tr>
                    </thead>
                    <tbody id="patterns-table">
                        <!-- Dynamic -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Determine API URL based on how the page is accessed
        const API_URL = window.location.protocol === 'file:'
            ? "http://localhost:8000/api"
            : "/api";

        async function refreshData() {
            try {
                // Trades Stats
                const tRes = await fetch(`${API_URL}/stats/trades`);
                if (!tRes.ok) throw new Error(`Trades API Error: ${tRes.statusText}`);
                const tData = await tRes.json();

                const elTrades = document.getElementById('stat-trades');
                if (elTrades) elTrades.innerText = tData.total_trades || 0;

                const elWinRate = document.getElementById('stat-winrate');
                if (elWinRate) elWinRate.innerText = (tData.win_rate || 0).toFixed(1) + '%';

                // Strategies
                const sRes = await fetch(`${API_URL}/strategies/approved`);
                if (!sRes.ok) throw new Error(`Strategies API Error: ${sRes.statusText}`);
                const sData = await sRes.json();

                document.getElementById('stat-strategies').innerText = sData.length;

                const sList = document.getElementById('strategies-list');
                if (sList) {
                    sList.innerHTML = '';
                    if (sData.length === 0) {
                        sList.innerHTML = '<div class="text-gray-500 italic">No approved strategies yet.</div>';
                    } else {
                        sData.forEach(s => {
                            const div = document.createElement('div');
                            div.className = "bg-gray-700 p-3 rounded flex justify-between items-center";
                            div.innerHTML = `
                                <div>
                                    <div class="font-bold text-blue-300">${s.name}</div>
                                    <div class="text-xs text-gray-400">PF: ${s.pf} | WR: ${s.wr}%</div>
                                </div>
                                <span class="bg-green-900 text-green-300 px-2 py-1 rounded text-xs">APPROVED</span>
                            `;
                            sList.appendChild(div);
                        });
                    }
                }

                // Patterns
                const pRes = await fetch(`${API_URL}/ml/patterns`);
                if (!pRes.ok) throw new Error(`Patterns API Error: ${pRes.statusText}`);
                const pData = await pRes.json();

                document.getElementById('stat-patterns').innerText = pData.length;

                const pTable = document.getElementById('patterns-table');
                if (pTable) {
                    pTable.innerHTML = '';
                    pData.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-700 last:border-0 hover:bg-gray-750";
                        tr.innerHTML = `
                            <td class="py-2 pr-4">${p.desc}</td>
                            <td class="py-2 text-red-400 font-bold">${p.win_rate.toFixed(1)}%</td>
                            <td class="py-2 text-gray-400">${p.samples}</td>
                        `;
                        pTable.appendChild(tr);
                    });
                }

            } catch (e) {
                console.error("Error fetching data:", e);
                const statusDiv = document.getElementById('pipeline-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="text-red-400 font-bold">Error: ${e.message}</div>
                        <div class="text-xs text-gray-500 mt-1">Stack: ${e.stack}</div>
                        <div class="text-xs text-gray-500 mt-1">URL: ${API_URL}</div>
                    `;
                }
            }
        }

        let currentTaskId = null;
        let pollInterval = null;

        async function startPipeline() {
            const btn = document.querySelector('button[onclick="startPipeline()"]');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            document.getElementById('pipeline-status').innerText = 'Starting Pipeline...';

            try {
                const res = await fetch(`${API_URL}/run-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pairs: ['BTCUSDT'],
                        years: [2024],
                        train_months: [1, 2, 3],
                        val_months: [4],
                        num_mutations: 3
                    })
                });
                const data = await res.json();
                currentTaskId = data.task_id;
                document.getElementById('pipeline-status').innerText = `Pipeline Started (Task ID: ${currentTaskId})`;

                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(checkStatus, 2000);
            } catch (e) {
                document.getElementById('pipeline-status').innerText = 'Error starting pipeline.';
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function checkStatus() {
            if (!currentTaskId) return;
            try {
                const res = await fetch(`${API_URL}/tasks/${currentTaskId}`);
                const data = await res.json();

                if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                    clearInterval(pollInterval);
                    const btn = document.querySelector('button[onclick="startPipeline()"]');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');

                    if (data.status === 'COMPLETED') {
                        document.getElementById('pipeline-status').innerHTML = `
                            <div class="text-green-500 font-bold">Pipeline COMPLETED Successfully.</div>
                            <div class="mt-2 text-xs text-gray-400">
                                Approved: ${data.result.approved_strategies}<br>
                                Patterns Found: ${data.result.patterns_found}
                            </div>
                        `;
                        refreshData();
                    } else {
                        document.getElementById('pipeline-status').innerText = `Pipeline FAILED: ${data.error}`;
                    }
                } else {
                    document.getElementById('pipeline-status').innerText = `Pipeline Running... (${data.status})`;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Initial Load
        refreshData();
    </script>
</body>

</html>